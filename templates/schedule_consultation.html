<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Agendar Consulta - RafahMed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-deep: #080b12;
      --bg-dark: #0b1220;
      --bg-elev: #111827;
      --bg-elev-2: #0f172a;
      --text: #e5e7eb;
      --text-dim: #cbd5e1;
      --muted: #94a3b8;
      --stroke: #1f2937;
      --red: #dd1b35;
      --red-dark: #b81429
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: radial-gradient(1000px 600px at 10% 0%, #0b1428 0%, transparent 50%), radial-gradient(900px 600px at 90% 10%, #0a0f1f 0%, transparent 50%), linear-gradient(135deg, var(--bg-deep) 0%, var(--bg-dark) 100%);
      color: var(--text);
      margin: 0
    }

    .card {
      background: linear-gradient(145deg, var(--bg-elev) 0%, var(--bg-elev-2) 100%);
      border: 1px solid rgba(255, 255, 255, .06);
      box-shadow: 0 16px 40px rgba(0, 0, 0, .45)
    }

    label {
      color: var(--text-dim)
    }

    .input,
    .select {
      width: 100%;
      padding: .6rem .9rem;
      border-radius: .5rem;
      border: 1px solid var(--stroke);
      background: var(--bg-elev-2);
      color: var(--text);
      outline: none;
      transition: .2s
    }

    .input:focus,
    .select:focus {
      border-color: var(--red);
      box-shadow: 0 0 0 4px rgba(221, 27, 53, .12)
    }

    .btn {
      width: 100%;
      padding: .85rem;
      background: linear-gradient(135deg, var(--red), var(--red-dark));
      color: #fff;
      font-weight: 700;
      border: 0;
      border-radius: .6rem;
      cursor: pointer;
      transition: .25s;
      box-shadow: 0 12px 30px rgba(221, 27, 53, .28)
    }

    .btn:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 18px 44px rgba(221, 27, 53, .38)
    }

    a.link {
      color: #93c5fd
    }

    .helper {
      font-size: .82rem;
      color: var(--muted)
    }
  </style>
</head>

<body>
  <div class="min-h-screen flex flex-col items-center justify-center px-4 pt-10">
    <div class="card rounded-xl w-full max-w-md p-8">
      <h1 class="text-2xl font-bold text-center mb-6" style="color:var(--red)">Agendar Consulta</h1>

      <form action="{{ url_for('submit_patient_consultation') }}" method="POST" class="space-y-4"
        onsubmit="return validateCPFForm()">
        <div>
          <label for="name" class="block text-sm font-medium">Nome completo</label>
          <input type="text" name="name" id="name" required class="input">
        </div>

        <div>
          <label for="cpf" class="block text-sm font-medium">CPF</label>
          <input type="text" name="cpf" id="cpf" required maxlength="14" class="input" placeholder="000.000.000-00">
        </div>

        <div>
          <label for="phone" class="block text-sm font-medium">Telefone para contato</label>
          <input type="text" name="phone" id="phone" required maxlength="15" class="input"
            placeholder="(00) 00000-0000">
        </div>

        <div>
          <label for="doctor" class="block text-sm font-medium">Médico</label>
          <select name="doctor_id" id="doctor" required class="select" onchange="loadDates()">
            <option value="">Selecione um médico</option>
            {% for d in doctors %}<option value="{{ d.id }}">{{ d.name }}</option>{% endfor %}
          </select>
          <div class="helper mt-1">Datas e horários são definidos pela disponibilidade do médico.</div>
        </div>

        <div>
          <label for="date" class="block text-sm font-medium">Data disponível</label>
          <select name="date" id="date" required class="select" disabled onchange="refreshTimes()">
            <option value="">Selecione um médico primeiro</option>
          </select>
        </div>

        <div>
          <label for="time" class="block text-sm font-medium">Horário disponível</label>
          <select name="time" id="time" required class="select" disabled>
            <option value="">Selecione a data</option>
          </select>
        </div>

        <div><button type="submit" class="btn">Confirmar Agendamento</button></div>
      </form>

      <div class="mt-6 text-center">
        <a href="{{ url_for('hero') }}" class="link hover:underline">Voltar para a página inicial</a>
      </div>
    </div>
  </div>

  <script>
    function validateCPFForm() {
      const cpf = document.getElementById("cpf").value.replace(/[^\d]+/g, '');
      if (!isValidCPF(cpf)) { alert("CPF inválido. Verifique e tente novamente."); return false; }
      return true;
    }
    function isValidCPF(cpf) {
      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
      let sum = 0; for (let i = 0; i < 9; i++)sum += parseInt(cpf[i]) * (10 - i);
      let d1 = (sum * 10) % 11; if (d1 === 10 || d1 === 11) d1 = 0; if (d1 !== parseInt(cpf[9])) return false;
      sum = 0; for (let i = 0; i < 10; i++)sum += parseInt(cpf[i]) * (11 - i);
      let d2 = (sum * 10) % 11; if (d2 === 10 || d2 === 11) d2 = 0; if (d2 !== parseInt(cpf[10])) return false; return true;
    }

    async function loadDates() {
      const doctor = document.getElementById('doctor').value;
      const dateSel = document.getElementById('date');
      const timeSel = document.getElementById('time');
      dateSel.innerHTML = ''; dateSel.disabled = true; timeSel.innerHTML = ''; timeSel.disabled = true;
      if (!doctor) { dateSel.innerHTML = '<option value="">Selecione um médico primeiro</option>'; return; }

      dateSel.innerHTML = '<option value="">Carregando datas...</option>';
      try {
        const r = await fetch(`{{ url_for('api_available_days') }}?doctor_id=${encodeURIComponent(doctor)}&days=90&_=${Date.now()}`, { cache: 'no-store' });
        const days = await r.json();
        dateSel.innerHTML = '';
        if (Array.isArray(days) && days.length) {
          dateSel.disabled = false;
          dateSel.appendChild(new Option('Selecione uma data', ''));
          days.forEach(d => dateSel.appendChild(new Option(d, d)));
        } else {
          dateSel.appendChild(new Option('Sem datas disponíveis', ''));
        }
      } catch (e) {
        console.error(e); dateSel.innerHTML = '<option value="">Erro ao carregar datas</option>';
      }
    }

    async function refreshTimes() {
      const doctor = document.getElementById('doctor').value;
      const datePt = document.getElementById('date').value;
      const timeSel = document.getElementById('time');
      timeSel.innerHTML = ''; timeSel.disabled = true;
      if (!doctor || !datePt) { timeSel.innerHTML = '<option value="">Selecione a data</option>'; return; }

      try {
        const r = await fetch(`{{ url_for('api_available_slots') }}?doctor_id=${encodeURIComponent(doctor)}&date=${encodeURIComponent(datePt)}&_=${Date.now()}`, { cache: 'no-store' });
        const slots = await r.json();
        if (Array.isArray(slots) && slots.length) {
          timeSel.disabled = false;
          timeSel.appendChild(new Option('Selecione um horário', ''));
          slots.forEach(s => timeSel.appendChild(new Option(s, s)));
        } else {
          timeSel.appendChild(new Option('Sem horários disponíveis nessa data', ''));
        }
      } catch (e) {
        console.error(e); timeSel.appendChild(new Option('Erro ao carregar horários', ''));
      }
    }

    document.getElementById('cpf').addEventListener('input', e => {
      let v = e.target.value.replace(/\D/g, '').slice(0, 11);
      v = v.replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      e.target.value = v;
    });
    document.getElementById('phone').addEventListener('input', e => {
      let v = e.target.value.replace(/\D/g, '').slice(0, 11);
      v = v.replace(/^(\d{2})(\d)/, '($1) $2').replace(/(\d{5})(\d{1,4})$/, '$1-$2');
      e.target.value = v;
    });
  </script>
</body>

</html>