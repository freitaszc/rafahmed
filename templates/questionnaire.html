<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>SRQ-20 — RafahMed</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-deep: #080b12;
            --bg-dark: #0b1220;
            --bg-elev: #111827;
            --bg-elev-2: #0f172a;
            --text: #e5e7eb;
            --text-dim: #cbd5e1;
            --muted: #94a3b8;
            --red: #dd1b35;
            --red-dark: #b81429;
            --stroke: #1f2937;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            padding: 16px;
            font-family: 'Montserrat', sans-serif;
            color: var(--text);
            background:
                radial-gradient(1000px 600px at 10% 0%, #0b1428 0%, transparent 50%),
                radial-gradient(900px 600px at 90% 10%, #0a0f1f 0%, transparent 50%),
                linear-gradient(135deg, var(--bg-deep) 0%, var(--bg-dark) 100%);
            min-height: 100vh;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--red) 0%, var(--red-dark) 100%);
            box-shadow: 0 10px 26px rgba(221, 27, 53, .25);
            transition: transform .25s ease, box-shadow .25s ease, filter .2s;
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 18px 40px rgba(221, 27, 53, .35);
            filter: saturate(1.03);
        }

        .question-card {
            background: linear-gradient(145deg, var(--bg-elev) 0%, var(--bg-elev-2) 100%);
            border: 1px solid rgba(255, 255, 255, .05);
            box-shadow: 0 16px 40px rgba(0, 0, 0, .45), 0 0 0 1px rgba(255, 255, 255, .04) inset;
        }

        .progress-wrap {
            max-width: 720px;
            margin: 0 auto 18px;
        }

        .progress-track {
            background: #0b1426;
            border: 1px solid var(--stroke);
            border-radius: 999px;
            height: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, .5);
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--red) 0%, var(--red-dark) 100%);
            transition: width .5s ease;
            height: 100%;
        }

        #progress-text {
            color: var(--text-dim);
        }

        .option-item {
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--stroke);
            transition: all .25s ease;
            cursor: pointer;
            border-radius: 14px;
        }

        .option-item:hover {
            background: rgba(221, 27, 53, .12);
            border-color: rgba(221, 27, 53, .35);
            transform: translateX(4px);
        }

        .option-item.selected {
            background: rgba(221, 27, 53, .16);
            border-color: var(--red);
            transform: translateX(4px);
        }

        .option-item input[type="radio"],
        .option-item input[type="checkbox"] {
            accent-color: var(--red);
        }

        .input-focus {
            width: 100%;
            border: 1px solid var(--stroke);
            border-radius: 14px;
            padding: 14px 18px;
            font-size: 1rem;
            color: var(--text);
            background: var(--bg-elev-2);
            transition: all .25s ease;
            outline: none;
        }

        .input-focus::placeholder {
            color: #64748b;
        }

        .input-focus:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 4px rgba(221, 27, 53, .12);
            border-color: var(--red);
        }

        .result-card {
            background: linear-gradient(145deg, var(--bg-elev) 0%, var(--bg-elev-2) 100%);
            border: 1px solid rgba(255, 255, 255, .06);
            box-shadow: 0 16px 40px rgba(0, 0, 0, .45);
        }

        .alert {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 50;
            background: linear-gradient(135deg, #7f1d1d, #450a0a);
            color: #fecaca;
            border: 1px solid rgba(239, 68, 68, .35);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 10px 26px rgba(0, 0, 0, .45);
            animation: slideUp .4s ease;
        }

        .fade-in {
            animation: fadeIn .6s ease-out;
        }

        .slide-up {
            animation: slideUp .6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .consent-box {
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--stroke);
            border-radius: 14px;
            padding: 16px;
            color: var(--text-dim);
            line-height: 1.6;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="w-full flex justify-center py-6">
        <img src="{{ url_for('static', filename='images/flatlogo.svg') }}" alt="Logo RafahMed" class="h-14 md:h-16">
    </header>

    <!-- Progresso -->
    <div class="progress-wrap">
        <div class="progress-track">
            <div id="progress-bar" class="progress-bar" style="width:0%"></div>
        </div>
        <p id="progress-text" class="text-sm mt-2 text-center">Pergunta 1</p>
    </div>

    <div class="max-w-2xl mx-auto question-card rounded-3xl p-8 mt-4">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-8">SRQ-20 — Questionário de Auto-Relato</h1>
        <div id="quiz-container" class="space-y-6"></div>
    </div>

    <script>
        function getAdminIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get("admin");
        }

        // === Perguntas SRQ-20 ===
        const quiz = [
            {
                type: "info",
                key: "srq20_intro",
                question: "Instruções do SRQ-20",
                description: `
          <div class="consent-box">
            <p><strong>Sobre:</strong> O SRQ-20 é um instrumento da Organização Mundial da Saúde para triagem de <strong>Transtornos Mentais Comuns (TMC)</strong>.</p>
            <p><strong>Como responder:</strong> Marque “Sim” apenas se o sintoma esteve presente nos <strong>últimos 30 dias</strong>.</p>
            <p><em>Atenção:</em> É uma <strong>triagem</strong>, não um diagnóstico. Resultados são confidenciais e protegidos pela <strong>LGPD</strong>.</p>
          </div>
        `
            },
            // Nome obrigatório
            { type: "text_required", key: "nome", question: "Digite seu nome completo" },

            {
                type: "radio",
                key: "consentimento",
                question: "Termo de consentimento",
                description: `
          <div class="consent-box">
            <p>De forma livre e voluntária, <strong>autorizo e concordo</strong> que a <strong>RafahMed</strong> colete e trate minhas respostas para fins de <strong>triagem e encaminhamento</strong> no Programa de Saúde Emocional.</p>
            <p>Os dados são mantidos sob <strong>sigilo profissional</strong> e não são compartilhados individualmente com empresas; somente <strong>indicadores agregados</strong> podem ser reportados.</p>
          </div>
        `,
                options: ["Li e concordo", "Li e não concordo"]
            },

            { type: "radio", key: "sexo", question: "Sexo", options: ["Feminino", "Masculino", "Outro", "Prefiro não dizer"] },
            { type: "text", key: "idade", question: "Idade (opcional)" },

            // 20 itens SRQ-20
            { type: "radio", key: "srq_q1", question: "Você tem dores de cabeça com frequência?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q2", question: "Tem falta de apetite?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q3", question: "Dorme mal?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q4", question: "Assusta-se com facilidade?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q5", question: "Tem tremores nas mãos?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q6", question: "Sente-se nervoso(a), tenso(a) ou preocupado(a)?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q7", question: "Tem má digestão?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q8", question: "Tem dificuldade de pensar com clareza?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q9", question: "Tem se sentido triste ultimamente?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q10", question: "Tem chorado mais do que de costume?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q11", question: "Encontra dificuldade para aproveitar suas atividades diárias?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q12", question: "Tem dificuldades para tomar decisões?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q13", question: "Seu trabalho diário tem sofrido por causa do seu estado?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q14", question: "É incapaz de desempenhar um papel útil na sua vida?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q15", question: "Perdeu o interesse pelas coisas?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q16", question: "Sente que você é uma pessoa inútil?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q17", question: "Tem tido a ideia de acabar com a vida?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q18", question: "Sente-se cansado(a) o tempo todo?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q19", question: "Sente desconforto estomacal?", options: ["Sim", "Não"] },
            { type: "radio", key: "srq_q20", question: "Cansa-se com facilidade?", options: ["Sim", "Não"] }
        ];

        // Mapa: chave -> enunciado (preenchido programaticamente a partir do array 'quiz')
        const questionLabels = {};
        quiz.forEach(item => {
            if (item.key && item.key.startsWith('srq_q')) {
                questionLabels[item.key] = item.question;
            }
        });

        let currentQuestion = 0;
        const answers = {};
        const container = document.getElementById("quiz-container");

        function updateProgress() {
            const progress = ((currentQuestion + 1) / quiz.length) * 100;
            document.getElementById("progress-bar").style.width = progress + "%";
            document.getElementById("progress-text").textContent = `Pergunta ${currentQuestion + 1} de ${quiz.length}`;
        }

        function renderQuestion() {
            const q = quiz[currentQuestion];
            updateProgress();
            const descriptionHTML = q.description ? `<div class="mb-5">${q.description}</div>` : "";

            let optionsHTML = "";
            if (q.type === "radio") {
                optionsHTML = q.options.map(opt => `
          <div class="option-item px-6 py-4" onclick="selectOption('${opt}', this)">
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="q" value="${opt}" class="mr-4 w-4 h-4">
              <span class="font-medium">${opt}</span>
            </label>
          </div>`).join("");
            } else if (q.type === "checkbox") {
                optionsHTML = q.options.map(opt => `
          <div class="option-item px-6 py-4" onclick="toggleCheckbox('${opt}', this)">
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" name="q" value="${opt}" class="mr-4 w-4 h-4">
              <span class="font-medium">${opt}</span>
            </label>
          </div>`).join("");
            } else if (q.type === "text" || q.type === "text_required") {
                optionsHTML = `
          <div class="relative">
            <input type="text" id="text-input" placeholder="Digite sua resposta..." class="input-focus">
          </div>`;
            }

            container.innerHTML = `
        <div class="fade-in">
          <div class="text-center mb-6">
            <p class="text-xl font-semibold mb-6 leading-relaxed">${q.question}</p>
          </div>
          ${descriptionHTML}
          <div class="space-y-3 mb-8">${optionsHTML}</div>
          <div class="text-center">
            <button onclick="next()" class="btn-primary text-white px-8 py-4 rounded-xl text-lg font-semibold inline-flex items-center gap-3">
              <span>Continuar</span>
            </button>
          </div>
        </div>`;
        }

        function selectOption(_, element) {
            document.querySelectorAll('.option-item').forEach(i => i.classList.remove('selected'));
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }
        function toggleCheckbox(_, element) {
            const checkbox = element.querySelector('input');
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('selected', checkbox.checked);
        }

        function showAlert(msg) {
            const d = document.createElement('div');
            d.className = 'alert';
            d.textContent = msg;
            document.body.appendChild(d);
            setTimeout(() => d.remove(), 3000);
        }

        function endEvaluationDueToNoConsent() {
            for (const k in answers) delete answers[k];
            document.getElementById("progress-bar").style.width = "100%";
            document.getElementById("progress-text").textContent = "Avaliação encerrada";
            container.innerHTML = `
        <div class="result-card rounded-2xl p-8 space-y-6 slide-up">
          <div class="text-center">
            <h2 class="text-2xl font-bold mb-2" style="color:var(--text)">Avaliação encerrada</h2>
            <p style="color:var(--text-dim); line-height:1.6">
              Você selecionou <strong>“Li e não concordo”</strong> no termo de consentimento.
              Para participar do SRQ-20, é necessário aceitar o termo.
            </p>
            <div class="mt-6 flex items-center justify-center gap-3">
              <button onclick="restartQuiz()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold">
                Reiniciar
              </button>
            </div>
          </div>
        </div>`;
        }

        function restartQuiz() {
            currentQuestion = 0;
            for (const k in answers) delete answers[k];
            renderQuestion();
        }

        // Scoring SRQ-20
        function scoreSRQ20(ans) {
            const keys = Array.from({ length: 20 }, (_, i) => `srq_q${i + 1}`);
            let total = 0, itensSim = [];
            keys.forEach(k => {
                const v = (ans[k] || "").toLowerCase();
                if (v === "sim") { total++; itensSim.push(k); }
            });

            const sexo = (ans.sexo || "").toLowerCase();
            let classe;
            if (sexo === "masculino") {
                if (total >= 7) classe = "Provável TMC (≥7, corte masc.)";
                else if (total >= 5) classe = "Risco leve (5–6)";
                else classe = "Sem indicativo (0–4)";
            } else if (sexo === "feminino") {
                if (total >= 7) classe = "Provável TMC (≥7, corte fem.)";
                else if (total >= 5) classe = "Risco leve (5–6)";
                else classe = "Sem indicativo (0–4)";
            } else {
                if (total >= 8) classe = "Provável TMC (≥8)";
                else if (total >= 5) classe = "Risco leve (5–7)";
                else classe = "Sem indicativo (0–4)";
            }

            return { total, classe, itensSim };
        }

        function next() {
            const q = quiz[currentQuestion];

            if (q.type === "info") {
                // apenas avança
            } else if (q.type === "text" || q.type === "text_required") {
                const val = (document.getElementById("text-input").value || "").trim();

                if (q.type === "text_required" && !val) {
                    return showAlert("Por favor, preencha seu nome completo.");
                }
                // campo opcional salva se preenchido
                answers[q.key] = val || answers[q.key] || "";

            } else if (q.type === "radio") {
                const sel = document.querySelector("input[name='q']:checked");
                if (!sel) return showAlert("Por favor, selecione uma opção.");

                if (q.key === "consentimento" && sel.value === "Li e não concordo") {
                    return endEvaluationDueToNoConsent();
                }

                // Alerta imediato para ideação suicida (q17)
                if (q.key === "srq_q17" && sel.value === "Sim") {
                    showAlert("Se você está pensando em se machucar, procure ajuda imediatamente. Ligue 188 (CVV) ou busque um serviço de emergência.");
                }

                answers[q.key] = sel.value;

            } else if (q.type === "checkbox") {
                const sel = [...document.querySelectorAll("input[name='q']:checked")].map(e => e.value);
                if (sel.length === 0) return showAlert("Por favor, selecione ao menos uma opção.");
                answers[q.key] = sel;
            }

            currentQuestion++;
            if (currentQuestion < quiz.length) {
                setTimeout(renderQuestion, 250);
            } else {
                setTimeout(showResult, 250);
            }
        }

        function showResult() {
            const srq = scoreSRQ20(answers);
            answers.srq20_total = srq.total;
            answers.srq20_classificacao = srq.classe;
            answers.srq20_itens_sim = srq.itensSim;

            // Labels legíveis dos itens "Sim"
            const itensSimLabels = srq.itensSim.map(code => questionLabels[code] || code);
            answers.srq20_itens_sim_labels = itensSimLabels;

            const adminId = getAdminIdFromURL();
            fetch(`/submit_srq20?admin=${adminId || ''}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(answers)
            }).catch(() => { });

            document.getElementById("progress-bar").style.width = "100%";
            document.getElementById("progress-text").textContent = "SRQ-20 Concluído";

            // bloco de resultado (inclui nome do paciente e lista dos enunciados marcados "Sim")
            container.innerHTML = `
        <div class="result-card rounded-2xl p-8 space-y-6 slide-up">
          <div class="text-center">
            <h2 class="text-3xl font-bold mb-2" style="color:var(--text)">Resultado — SRQ-20</h2>
            <p class="text-base" style="color:var(--text-dim)">Nome: <strong>${answers.nome || 'Não informado'}</strong></p>
            <p class="text-lg" style="color:var(--text-dim)">Pontuação total: <strong>${answers.srq20_total}/20</strong></p>
            <p class="text-lg">Classificação: <strong>${answers.srq20_classificacao}</strong></p>
          </div>

          <div class="rounded-xl p-6" style="background:rgba(255,255,255,.03); border:1px solid var(--stroke);">
            <p class="mb-2" style="color:var(--text-dim)">
<strong>Obrigado por preencher o SRQ-20.</strong>
            </p>

            ${answers["srq_q17"] === "Sim" ? `
              <div class="mt-4 p-4 rounded-lg" style="background:rgba(127,29,29,.35); border:1px solid rgba(239,68,68,.35);">
                <p class="font-semibold mb-1">Atenção: item sobre ideação suicida marcado como “Sim”.</p>
                <p>Se você está em risco ou pensando em se machucar, procure ajuda imediatamente.</p>
                <ul class="list-disc ml-5 mt-2">
                  <li>Brasil: Ligue <strong>188 (CVV)</strong> — atendimento 24h.</li>
                  <li>Emergência: procure um serviço de urgência mais próximo.</li>
                </ul>
              </div>
            ` : ``}

            <div class="mt-6">
              <p class="font-semibold mb-2">Itens marcados “Sim”:</p>
              ${itensSimLabels.length ? `
                <ul class="list-disc ml-6 space-y-1">
                  ${itensSimLabels.map(t => `<li>${t}</li>`).join('')}
                </ul>
              ` : `<p>Nenhum.</p>`}
            </div>
          </div>

          <div class="text-center">
            <button onclick="restartQuiz()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold">
              Reiniciar
            </button>
          </div>
        </div>`;
        }

        // start
        renderQuestion();
    </script>
</body>

</html>