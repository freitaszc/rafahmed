<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Autoavaliação - RafahMed</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-deep: #080b12;
            --bg-dark: #0b1220;
            --bg-elev: #111827;
            --bg-elev-2: #0f172a;
            --text: #e5e7eb;
            --text-dim: #cbd5e1;
            --muted: #94a3b8;
            --red: #dd1b35;
            --red-dark: #b81429;
            --stroke: #1f2937;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            padding: 16px;
            font-family: 'Montserrat', sans-serif;
            color: var(--text);
            background:
                radial-gradient(1000px 600px at 10% 0%, #0b1428 0%, transparent 50%),
                radial-gradient(900px 600px at 90% 10%, #0a0f1f 0%, transparent 50%),
                linear-gradient(135deg, var(--bg-deep) 0%, var(--bg-dark) 100%);
            min-height: 100vh;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--red) 0%, var(--red-dark) 100%);
            box-shadow: 0 10px 26px rgba(221, 27, 53, .25);
            transition: transform .25s ease, box-shadow .25s ease, filter .2s;
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 18px 40px rgba(221, 27, 53, .35);
            filter: saturate(1.03);
        }

        .question-card {
            background: linear-gradient(145deg, var(--bg-elev) 0%, var(--bg-elev-2) 100%);
            border: 1px solid rgba(255, 255, 255, .05);
            box-shadow: 0 16px 40px rgba(0, 0, 0, .45), 0 0 0 1px rgba(255, 255, 255, .04) inset;
        }

        .progress-wrap {
            max-width: 720px;
            margin: 0 auto 18px;
        }

        .progress-track {
            background: #0b1426;
            border: 1px solid var(--stroke);
            border-radius: 999px;
            height: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, .5);
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--red) 0%, var(--red-dark) 100%);
            transition: width .5s ease;
            height: 100%;
        }

        #progress-text {
            color: var(--text-dim);
        }

        .option-item {
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--stroke);
            transition: all .25s ease;
            cursor: pointer;
            border-radius: 14px;
        }

        .option-item:hover {
            background: rgba(221, 27, 53, .12);
            border-color: rgba(221, 27, 53, .35);
            transform: translateX(4px);
        }

        .option-item.selected {
            background: rgba(221, 27, 53, .16);
            border-color: var(--red);
            transform: translateX(4px);
        }

        .option-item input[type="radio"],
        .option-item input[type="checkbox"] {
            accent-color: var(--red);
        }

        .input-focus {
            width: 100%;
            border: 1px solid var(--stroke);
            border-radius: 14px;
            padding: 14px 18px;
            font-size: 1rem;
            color: var(--text);
            background: var(--bg-elev-2);
            transition: all .25s ease;
            outline: none;
        }

        .input-focus::placeholder {
            color: #64748b;
        }

        .input-focus:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 4px rgba(221, 27, 53, .12);
            border-color: var(--red);
        }

        .result-card {
            background: linear-gradient(145deg, var(--bg-elev) 0%, var(--bg-elev-2) 100%);
            border: 1px solid rgba(255, 255, 255, .06);
            box-shadow: 0 16px 40px rgba(0, 0, 0, .45);
        }

        .alert {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 50;
            background: linear-gradient(135deg, #7f1d1d, #450a0a);
            color: #fecaca;
            border: 1px solid rgba(239, 68, 68, .35);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 10px 26px rgba(0, 0, 0, .45);
            animation: slideUp .4s ease;
        }

        .fade-in {
            animation: fadeIn .6s ease-out;
        }

        .slide-up {
            animation: slideUp .6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .consent-box {
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--stroke);
            border-radius: 14px;
            padding: 16px;
            color: var(--text-dim);
            line-height: 1.6;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="w-full flex justify-center py-6">
        <img src="{{ url_for('static', filename='images/flatlogo.svg') }}" alt="Logo RafahMed" class="h-14 md:h-16">
    </header>

    <!-- Progresso -->
    <div class="progress-wrap">
        <div class="progress-track">
            <div id="progress-bar" class="progress-bar" style="width:0%"></div>
        </div>
        <p id="progress-text" class="text-sm mt-2 text-center">Pergunta 1</p>
    </div>

    <div class="max-w-2xl mx-auto question-card rounded-3xl p-8 mt-4">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-8">Autoavaliação de Saúde Mental</h1>
        <div id="quiz-container" class="space-y-6"></div>
    </div>

    <script>
        function getAdminIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get("admin");
        }

        // === Perguntas ===
        const quiz = [
            // 1) Consentimento obrigatório
            {
                type: "radio",
                key: "consentimento",
                question: "Termo de consentimento",
                description: `
          <div class="consent-box">
            <p>De forma livre e voluntária, <strong>autorizo e concordo</strong> que a <strong>RafahMed</strong> me inclua no <strong>Programa de Saúde Emocional</strong>.</p>
            <p>As informações obtidas neste questionário têm como objetivo oferecer a melhor trilha de cuidado dentro do programa, de acordo com as demandas apresentadas, e <strong>não são compartilhadas de forma individual com empresas</strong>.</p>
            <p>Se o resultado indicar <strong>risco psicossocial moderado ou alto</strong>, a equipe de navegação de cuidado poderá entrar em contato via WhatsApp para oferecer auxílio.</p>
            <p>Os resultados são mantidos sob <strong>sigilo profissional</strong> pela equipe clínica, em conformidade com a legislação vigente e a <strong>LGPD</strong> (Lei nº 13.709/2018, alterada pela Lei nº 13.853/2019).</p>
          </div>
        `,
                options: ["Li e concordo", "Li e não concordo"]
            },

            { type: "text", key: "nome", question: "Qual seu nome?" },
            { type: "text", key: "idade", question: "Qual sua idade?" },
            {
                type: "radio",
                key: "nivel_hierarquico",
                question: "Qual é o seu nível hierárquico na empresa em que trabalha?",
                options: ["Analista", "Assistente", "Auxiliar", "Consultor", "Coordenador", "Gerente", "Supervisor(a)", "Outro"]
            },
            { type: "text", key: "setor", question: "Em qual setor você trabalha?" },
            { type: "radio", key: "nervosismo", question: "Nas últimas 2 semanas, com que frequência você se sentiu nervoso(a), ansioso(a) ou muito tenso(a)?", options: ["Quase todos os dias", "Alguns dias", "Poucos dias", "Quase nunca"] },
            { type: "radio", key: "preocupacao", question: "Nas últimas 2 semanas, você não foi capaz de controlar a preocupação?", options: ["Quase todos os dias", "Alguns dias", "Poucos dias", "Quase nunca"] },
            { type: "radio", key: "interesse", question: "Nas últimas 2 semanas, você teve pouco interesse ou prazer em fazer as coisas?", options: ["Quase todos os dias", "Alguns dias", "Poucos dias", "Quase nunca"] },
            { type: "radio", key: "depressao_raw", question: "Nas últimas 2 semanas, você se sentiu desanimado(a), deprimido(a) ou sem esperança?", options: ["Quase todos os dias", "Alguns dias", "Poucos dias", "Quase nunca"] },
            { type: "radio", key: "estresse", question: "Considerando as últimas 2 semanas, o quanto você sentiu que estava estressado(a)?", options: ["Quase todos os dias", "Alguns dias", "Poucos dias", "Quase nunca"] },
            { type: "radio", key: "hora_extra", question: "Considerando uma semana de trabalho normal, quantos dias você normalmente precisa fazer hora extra?", options: ["Todos os dias da semana", "De 3 a 4 dias da semana", "De 1 a 2 dias da semana", "Nunca"] },
            { type: "radio", key: "sono", question: "Como você classificaria sua qualidade do sono nas últimas 2 semanas?", options: ["Muito ruim", "Ruim", "Regular", "Boa", "Excelente"] },
            { type: "radio", key: "atividade_fisica", question: "Com que frequência você pratica atividade física?", options: ["Diariamente", "3-4 vezes por semana", "1-2 vezes por semana", "Raramente", "Nunca"] },
            { type: "checkbox", key: "fatores", question: "Pensando na sua saúde mental e qualidade de vida, quais fatores mais impactam?", options: ["Quero me conhecer melhor", "Ansiedade", "Depressão", "Ambiente Profissional", "Tabagismo", "Álcool", "Relacionamento", "Estresse", "Sexualidade", "Transtornos alimentares", "Sobrepeso/Obesidade", "Autoestima/Motivação", "Diversidade", "Problemas Financeiros"] },
            {
                type: "checkbox",
                key: "motivacao",
                question: "Sobre a questão apontada, em qual estágio de motivação você está para tentar resolver?",
                options: [
                    "Acredito que não tenho necessidade de seguir com o programa; preenchi por indicação.",
                    "Quero agendar atendimento, mas ainda não priorizei. Gostaria de começar a agir.",
                    "Avalio que o problema tem me trazido impactos e estou pensando em ações para melhorar.",
                    "Já estou fazendo algumas mudanças e buscando novas ações para melhorar.",
                    "Eu havia melhorado, mas tive uma recaída."
                ]
            },
            { type: "text", key: "pronto_socorro", question: "Nos últimos 3 meses, quantas vezes você utilizou o pronto socorro?" },
            { type: "radio", key: "relacionamentos", question: "Como você avalia seu relacionamento com família e amigos?", options: ["Excelente", "Bom", "Regular", "Ruim", "Muito ruim"] },
            { type: "radio", key: "hobbies", question: "Você tem algum hobby ou atividade que lhe dá prazer?", options: ["Sim, pratico regularmente", "Sim, mas raramente pratico", "Tenho interesse mas não pratico", "Não tenho hobbies"] }
        ];

        let currentQuestion = 0;
        const answers = {};
        const container = document.getElementById("quiz-container");

        function updateProgress() {
            const progress = ((currentQuestion + 1) / quiz.length) * 100;
            document.getElementById("progress-bar").style.width = progress + "%";
            document.getElementById("progress-text").textContent = `Pergunta ${currentQuestion + 1} de ${quiz.length}`;
        }

        function renderQuestion() {
            const q = quiz[currentQuestion];
            updateProgress();

            const descriptionHTML = q.description ? `<div class="mb-5">${q.description}</div>` : "";

            container.innerHTML = `
        <div class="fade-in">
          <div class="text-center mb-6">
            <p class="text-xl font-semibold mb-6 leading-relaxed">${q.question}</p>
          </div>

          ${descriptionHTML}

          <div class="space-y-3 mb-8">
            ${q.type === "radio" ? q.options.map(opt => `
              <div class="option-item px-6 py-4" onclick="selectOption('${opt}', this)">
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="q" value="${opt}" class="mr-4 w-4 h-4">
                  <span class="font-medium">${opt}</span>
                </label>
              </div>`).join("") : ""}

            ${q.type === "checkbox" ? q.options.map(opt => `
              <div class="option-item px-6 py-4" onclick="toggleCheckbox('${opt}', this)">
                <label class="flex items-center cursor-pointer">
                  <input type="checkbox" name="q" value="${opt}" class="mr-4 w-4 h-4">
                  <span class="font-medium">${opt}</span>
                </label>
              </div>`).join("") : ""}

            ${q.type === "text" ? `
              <div class="relative">
                <input type="text" id="text-input" placeholder="Digite sua resposta..." class="input-focus">
              </div>` : ""}
          </div>

          <div class="text-center">
            <button onclick="next()" class="btn-primary text-white px-8 py-4 rounded-xl text-lg font-semibold inline-flex items-center gap-3">
              <span>Continuar</span><span class="text-xl">→</span>
            </button>
          </div>
        </div>`;
        }

        function selectOption(_, element) {
            document.querySelectorAll('.option-item').forEach(i => i.classList.remove('selected'));
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }
        function toggleCheckbox(_, element) {
            const checkbox = element.querySelector('input');
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('selected', checkbox.checked);
        }

        function showAlert(msg) {
            const d = document.createElement('div');
            d.className = 'alert';
            d.textContent = msg;
            document.body.appendChild(d);
            setTimeout(() => d.remove(), 2800);
        }

        // === ENCERRA A AVALIAÇÃO SE NÃO CONCORDAR COM O TERMO ===
        function endEvaluationDueToNoConsent() {
            for (const k in answers) delete answers[k];

            document.getElementById("progress-bar").style.width = "100%";
            document.getElementById("progress-text").textContent = "Avaliação encerrada";

            container.innerHTML = `
        <div class="result-card rounded-2xl p-8 space-y-6 slide-up">
          <div class="text-center">
            <div class="text-6xl mb-4">🔒</div>
            <h2 class="text-2xl font-bold mb-2" style="color:var(--text)">Avaliação encerrada</h2>
            <p style="color:var(--text-dim); line-height:1.6">
              Você selecionou <strong>“Li e não concordo”</strong> no termo de consentimento.<br>
              Para participar da autoavaliação, é necessário aceitar o termo.
            </p>
            <div class="mt-6 flex items-center justify-center gap-3">
              <button onclick="restartQuiz()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold">
                Reiniciar avaliação
              </button>
            </div>
          </div>
        </div>`;
        }

        function restartQuiz() {
            currentQuestion = 0;
            for (const k in answers) delete answers[k];
            renderQuestion();
        }

        function next() {
            const q = quiz[currentQuestion];

            if (q.type === "text") {
                const val = document.getElementById("text-input").value;
                if (!val.trim()) return showAlert("Por favor, preencha o campo.");
                answers[q.key] = val;

            } else if (q.type === "radio") {
                const sel = document.querySelector("input[name='q']:checked");
                if (!sel) return showAlert("Por favor, selecione uma opção.");

                // ENCERRA SE NÃO CONCORDAR COM O TERMO
                if (q.key === "consentimento" && sel.value === "Li e não concordo") {
                    return endEvaluationDueToNoConsent();
                }

                answers[q.key] = sel.value;

            } else if (q.type === "checkbox") {
                const sel = [...document.querySelectorAll("input[name='q']:checked")].map(e => e.value);
                if (sel.length === 0) return showAlert("Por favor, selecione ao menos uma opção.");
                answers[q.key] = sel;
            }

            currentQuestion++;
            if (currentQuestion < quiz.length) {
                setTimeout(renderQuestion, 250);
            } else {
                setTimeout(showResult, 250);
            }
        }

        function getClassificacao(score, max) {
            const pct = (score / max) * 100;
            if (pct <= 25) return { nivel: 'BAIXO', cor: '#2ecc71' };
            if (pct <= 50) return { nivel: 'NORMAL/LEVE', cor: '#f1c40f' };
            if (pct <= 75) return { nivel: 'MODERADO', cor: '#e67e22' };
            return { nivel: 'ALTO', cor: '#e74c3c' };
        }

        function showResult() {
            const freqMap = { "Quase todos os dias": 4, "Alguns dias": 3, "Poucos dias": 2, "Quase nunca": 1 };
            const extraMap = { "Todos os dias da semana": 4, "De 3 a 4 dias da semana": 3, "De 1 a 2 dias da semana": 2, "Nunca": 1 };
            const sonoMap = { "Excelente": 5, "Boa": 4, "Regular": 3, "Ruim": 2, "Muito ruim": 1 };
            const atvMap = { "Diariamente": 5, "3-4 vezes/semana": 4, "3-4 vezes por semana": 4, "1-2 vezes por semana": 3, "Raramente": 2, "Nunca": 1 };

            const ansiedadeScore = (freqMap[answers.nervosismo] || 0) + (freqMap[answers.preocupacao] || 0);
            const depressaoScore = (freqMap[answers.interesse] || 0) + (freqMap[answers.depressao_raw] || 0);
            const estresseScore = (freqMap[answers.estresse] || 0) + (extraMap[answers.hora_extra] || 0);
            const qualidadeVidaScore = (sonoMap[answers.sono] || 0) + (atvMap[answers.atividade_fisica] || 0);

            const ansiedadeClass = getClassificacao(ansiedadeScore, 8);
            const depressaoClass = getClassificacao(depressaoScore, 8);
            const estresseClass = getClassificacao(estresseScore, 8);
            const qualidadeClass = getClassificacao(qualidadeVidaScore, 10);

            const scoreTotal = ansiedadeScore + depressaoScore + estresseScore + qualidadeVidaScore;
            const riscoPrincipal = getClassificacao(scoreTotal, 34);

            let recomendacao = "";
            if (riscoPrincipal.nivel === "BAIXO") recomendacao = "Sua saúde mental aparenta estar preservada. Continue cuidando de si!";
            else if (riscoPrincipal.nivel === "NORMAL/LEVE") recomendacao = "Há alguns sinais que merecem atenção. Considere práticas de autocuidado.";
            else if (riscoPrincipal.nivel === "MODERADO") recomendacao = "Identificamos sinais importantes. Recomendamos acompanhamento psicológico.";
            else recomendacao = "Indica necessidade de suporte prioritário. Busque ajuda profissional.";

            // Campos de classificação no payload final
            answers.ansiedade = ansiedadeClass.nivel; answers.ansiedade_cor = ansiedadeClass.cor;
            answers.depressao = depressaoClass.nivel; answers.depressao_cor = depressaoClass.cor;
            answers.estresse = estresseClass.nivel; answers.estresse_cor = estresseClass.cor;
            answers.qualidade = qualidadeClass.nivel; answers.qualidade_cor = qualidadeClass.cor;
            answers.risco = riscoPrincipal.nivel; answers.risco_cor = riscoPrincipal.cor;
            answers.recomendacao = recomendacao;

            const adminId = getAdminIdFromURL();
            fetch(`/submit_quiz?admin=${adminId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(answers)
            });

            document.getElementById("progress-bar").style.width = "100%";
            document.getElementById("progress-text").textContent = "Avaliação Concluída";

            const riscoEmoji = (riscoPrincipal.nivel === "BAIXO") ? "🌟"
                : (riscoPrincipal.nivel === "NORMAL/LEVE") ? "⚠️"
                    : (riscoPrincipal.nivel === "MODERADO") ? "🔶" : "🚨";

            container.innerHTML = `
        <div class="result-card rounded-2xl p-8 space-y-6 slide-up">
          <div class="text-center">
            <div class="text-6xl mb-4">${riscoEmoji}</div>
            <h2 class="text-3xl font-bold mb-2" style="color:var(--text)">Resultado da Avaliação</h2>
            <h3 class="text-xl font-semibold mb-4" style="color:var(--text-dim)">${answers.nome || ''},</h3>
          </div>

          <div class="rounded-xl p-6" style="background:rgba(255,255,255,.03); border:1px solid var(--stroke);">
            <div class="text-center">
              <p class="text-lg font-medium mb-4" style="color:var(--text)">
                Seu grau de risco é <span style="color:${riscoPrincipal.cor}; font-weight:800;">${riscoPrincipal.nivel}</span>.
              </p>
              <p style="color:var(--text-dim); line-height:1.6">${recomendacao}</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
              <div class="p-4 rounded-lg" style="background:rgba(255,255,255,.03); border:1px solid var(--stroke);">
                <p class="font-semibold">Ansiedade:</p>
                <span style="color:${ansiedadeClass.cor}; font-weight:bold;">${ansiedadeClass.nivel}</span>
              </div>
              <div class="p-4 rounded-lg" style="background:rgba(255,255,255,.03); border:1px solid var(--stroke);">
                <p class="font-semibold">Depressão:</p>
                <span style="color:${depressaoClass.cor}; font-weight:bold;">${depressaoClass.nivel}</span>
              </div>
              <div class="p-4 rounded-lg" style="background:rgba(255,255,255,.03); border:1px solid var(--stroke);">
                <p class="font-semibold">Estresse:</p>
                <span style="color:${estresseClass.cor}; font-weight:bold;">${estresseClass.nivel}</span>
              </div>
              <div class="p-4 rounded-lg" style="background:rgba(255,255,255,.03); border:1px solid var(--stroke);">
                <p class="font-semibold">Qualidade de Vida:</p>
                <span style="font-weight:bold; color:${qualidadeClass.nivel === "BAIXO" ? "#22c55e" :
                    qualidadeClass.nivel === "NORMAL/LEVE" ? "#eab308" :
                        qualidadeClass.nivel === "MODERADO" ? "#f97316" : "#ef4444"
                }">${qualidadeClass.nivel === "BAIXO" ? "BOA" :
                    qualidadeClass.nivel === "NORMAL/LEVE" ? "REGULAR" :
                        qualidadeClass.nivel === "MODERADO" ? "RUIM" : "MUITO RUIM"
                }</span>
              </div>
            </div>
          </div>
        </div>`;
        }

        // start
        renderQuestion();
    </script>
</body>

</html>