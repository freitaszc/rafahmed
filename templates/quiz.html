<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Autoavaliação - RafahMed</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #333;
            min-height: 100vh;
        }

        .btn-primary {
            background: linear-gradient(135deg, #dd1b35 0%, #b3182d 100%);
            box-shadow: 0 4px 15px rgba(221, 27, 53, 0.3);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(221, 27, 53, 0.4);
        }

        .logo {
            height: 60px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }

        .question-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .option-item {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .option-item:hover {
            background: rgba(221, 27, 53, 0.05);
            border-color: rgba(221, 27, 53, 0.3);
            transform: translateX(5px);
        }

        .option-item.selected {
            background: rgba(221, 27, 53, 0.1);
            border-color: #dd1b35;
            transform: translateX(5px);
        }

        .progress-bar {
            background: linear-gradient(90deg, #dd1b35 0%, #b3182d 100%);
            transition: width 0.5s ease;
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .slide-up {
            animation: slideUp 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .pulse-effect {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .input-focus {
            transition: all 0.3s ease;
        }

        .input-focus:focus {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(221, 27, 53, 0.2);
        }

        .result-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
            backdrop-filter: blur(15px);
        }
    </style>
</head>

<body class="p-4">

    <!-- Header com logo.svg animada -->
    <header class="w-full flex justify-center py-6">
        <img src="{{ url_for('static', filename='images/flatlogo.svg') }}" alt="Logo RafahMed"
            class="h-14 md:h-16 floating drop-shadow-md transition-transform duration-300 hover:scale-105">
    </header>

    <style>
        /* Efeito de flutuação leve */
        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-5px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }
    </style>


    <!-- Barra de progresso -->
    <div class="max-w-2xl mx-auto mb-6">
        <div class="bg-gray-200 rounded-full h-3 overflow-hidden">
            <div id="progress-bar" class="progress-bar h-full rounded-full" style="width: 0%"></div>
        </div>
        <p id="progress-text" class="text-sm text-gray-600 mt-2 text-center">Pergunta 1 de 14</p>
    </div>

    <div class="max-w-2xl mx-auto question-card rounded-3xl shadow-2xl p-8 mt-4">
        <h1 class="text-4xl font-bold text-center text-[#dd1b35] mb-8 pulse-effect">
            Autoavaliação de Saúde Mental
        </h1>
        <div id="quiz-container" class="space-y-6"></div>
    </div>

    <script>
        function getAdminIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get("admin");
        }
        const quiz = [
            { type: "text", question: "Qual seu nome?", key: "nome" },
            { type: "text", question: "Qual sua idade?", key: "idade" },
            {
                type: "radio",
                question: "Nas últimas 2 semanas, com que frequência você se sentiu nervoso(a), ansioso(a) ou muito tenso(a)?",
                key: "nervosismo",
                options: ["Quase todos os dias", "Alguns dias", "Poucos dias", "Quase nunca"]
            },
            {
                type: "radio",
                question: "Nas últimas 2 semanas, você não foi capaz de controlar a preocupação?",
                key: "preocupacao",
                options: ["Quase todos os dias", "Alguns dias", "Poucos dias", "Quase nunca"]
            },
            {
                type: "radio",
                question: "Nas últimas 2 semanas, você teve pouco interesse ou prazer em fazer as coisas?",
                key: "interesse",
                options: ["Quase todos os dias", "Alguns dias", "Poucos dias", "Quase nunca"]
            },
            {
                type: "radio",
                question: "Nas últimas 2 semanas, você se sentiu desanimado(a), deprimido(a) ou sem esperança?",
                key: "depressao_raw",
                options: ["Quase todos os dias", "Alguns dias", "Poucos dias", "Quase nunca"]
            },
            {
                type: "radio",
                question: "Considerando as últimas 2 semanas, o quanto você sentiu que estava estressado(a)?",
                key: "estresse",
                options: ["Quase todos os dias", "Alguns dias", "Poucos dias", "Quase nunca"]
            },
            {
                type: "radio",
                question: "Considerando uma semana de trabalho normal, quantos dias você normalmente precisa trabalhar a mais do que a sua carga horária habitual e/ou fazer hora extra?",
                key: "hora_extra",
                options: ["Todos os dias da semana", "De 3 a 4 dias da semana", "De 1 a 2 dias da semana", "Nunca"]
            },
            {
                type: "radio",
                question: "Como você classificaria sua qualidade do sono nas últimas 2 semanas?",
                key: "sono",
                options: ["Muito ruim", "Ruim", "Regular", "Boa", "Excelente"]
            },
            {
                type: "radio",
                question: "Com que frequência você pratica atividade física?",
                key: "atividade_fisica",
                options: ["Diariamente", "3-4 vezes por semana", "1-2 vezes por semana", "Raramente", "Nunca"]
            },
            {
                type: "checkbox",
                question: "Quando você pensa na sua saúde mental e qualidade de vida, quais os fatores que mais impactam?",
                key: "fatores",
                options: [
                    "Quero me conhecer melhor", "Ansiedade", "Depressão", "Ambiente Profissional",
                    "Tabagismo", "Álcool", "Relacionamento", "Estresse", "Sexualidade",
                    "Transtornos alimentares", "Sobrepeso/Obesidade", "Autoestima/Motivação",
                    "Diversidade", "Problemas Financeiros"
                ]
            },
            {
                type: "checkbox",
                question: "Com relação à questão apontada, em qual estágio de motivação você considera que está para tentar resolver a questão?",
                key: "motivacao",
                options: [
                    "Eu na verdade acredito que não tenho necessidade de seguir com o programa de saúde emocional, pois não acho que tenho algo a resolver. Resolvi preencher apenas por conta da indicação de outra pessoa.",
                    "Eu já estava querendo agendar um atendimento psicológico, mas ainda não havia conseguido me programar, pois acho que não é prioridade. Gostaria de começar a fazer algo a respeito do problema ou questão informada.",
                    "Com relação à questão apontada por mim eu avalio que tem me trazido problemas e estou pensando em ações que podem me ajudar a melhorar.",
                    "Com relação à questão apontada por mim, eu já tenho feito algumas mudanças e estou buscando mais ações que possam me ajudar a melhorar.",
                    "Eu já havia melhorado quanto ao problema apontado, mas tive uma recaída."
                ]
            },
            {
                type: "text",
                question: "Nos últimos 3 meses, quantas vezes você utilizou o pronto socorro?",
                key: "pronto_socorro",
            },
            {
                type: "radio",
                question: "Como você avalia seu relacionamento com família e amigos?",
                key: "relacionamentos",
                options: ["Excelente", "Bom", "Regular", "Ruim", "Muito ruim"]
            },
            {
                type: "radio",
                question: "Você tem algum hobby ou atividade que lhe dá prazer?",
                key: "hobbies",
                options: ["Sim, pratico regularmente", "Sim, mas raramente pratico", "Tenho interesse mas não pratico", "Não tenho hobbies"]
            }
        ];

        let currentQuestion = 0;
        const answers = {};
        const container = document.getElementById("quiz-container");

        function updateProgress() {
            const progress = ((currentQuestion + 1) / quiz.length) * 100;
            document.getElementById("progress-bar").style.width = progress + "%";
            document.getElementById("progress-text").textContent = `Pergunta ${currentQuestion + 1} de ${quiz.length}`;
        }

        function renderQuestion() {
            const q = quiz[currentQuestion];
            updateProgress();

            container.innerHTML = `
        <div class="fade-in">
          <div class="text-center mb-6">
            <p class="text-xl font-semibold text-[#dd1b35] mb-6 leading-relaxed">${q.question}</p>
          </div>
          <div class="space-y-3 mb-8">
            ${q.type === "radio" ? q.options.map((opt, index) => `
              <div class="option-item rounded-xl px-6 py-4 transition-all duration-300" onclick="selectOption('${opt}', this)">
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="q" value="${opt}" class="mr-4 w-4 h-4 text-[#dd1b35] focus:ring-[#dd1b35]"> 
                  <span class="font-medium">${opt}</span>
                </label>
              </div>
            `).join("") : ""}
            ${q.type === "checkbox" ? q.options.map((opt, index) => `
              <div class="option-item rounded-xl px-6 py-4 transition-all duration-300" onclick="toggleCheckbox('${opt}', this)">
                <label class="flex items-center cursor-pointer">
                  <input type="checkbox" name="q" value="${opt}" class="mr-4 w-4 h-4 text-[#dd1b35] focus:ring-[#dd1b35]"> 
                  <span class="font-medium">${opt}</span>
                </label>
              </div>
            `).join("") : ""}
            ${q.type === "text" ? `
              <div class="relative">
                <input type="text" id="text-input" placeholder="Digite sua resposta..." 
                       class="input-focus w-full border-2 border-gray-200 rounded-xl px-6 py-4 text-lg focus:outline-none focus:border-[#dd1b35] font-medium">
              </div>
            ` : ""}
          </div>
          <div class="text-center">
            <button onclick="next()" class="btn-primary text-white px-8 py-4 rounded-xl text-lg font-semibold transition-all duration-300 inline-flex items-center gap-3">
              <span>Continuar</span>
              <span class="text-xl">→</span>
            </button>
          </div>
        </div>
      `;
        }

        function selectOption(value, element) {
            // Remove seleção anterior
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Adiciona seleção atual
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        function toggleCheckbox(value, element) {
            const checkbox = element.querySelector('input');
            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                element.classList.add('selected');
            } else {
                element.classList.remove('selected');
            }
        }

        function next() {
            const q = quiz[currentQuestion];
            if (q.type === "text") {
                const input = document.getElementById("text-input").value;
                if (!input.trim()) return showAlert("Por favor, preencha o campo.");
                answers[q.key] = input;
            } else if (q.type === "radio") {
                const selected = document.querySelector("input[name='q']:checked");
                if (!selected) return showAlert("Por favor, selecione uma opção.");
                answers[q.key] = selected.value;
            } else if (q.type === "checkbox") {
                const selected = [...document.querySelectorAll("input[name='q']:checked")].map(e => e.value);
                if (selected.length === 0) return showAlert("Por favor, selecione ao menos uma opção.");
                answers[q.key] = selected;
            }

            currentQuestion++;
            if (currentQuestion < quiz.length) {
                setTimeout(() => renderQuestion(), 300);
            } else {
                setTimeout(() => showResult(), 300);
            }
        }

        function showAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50 slide-up';
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        function getClassificacao(score, max) {
            const pct = (score / max) * 100;
            if (pct <= 25) return { nivel: 'BAIXO', cor: '#2ecc71' };
            if (pct <= 50) return { nivel: 'NORMAL/LEVE', cor: '#f1c40f' };
            if (pct <= 75) return { nivel: 'MODERADO', cor: '#e67e22' };
            return { nivel: 'ALTO', cor: '#e74c3c' };
        }

        function showResult() {
            // 1) Mapas de valores
            const freqMap = {
                "Quase todos os dias": 4,
                "Alguns dias": 3,
                "Poucos dias": 2,
                "Quase nunca": 1
            };
            const extraMap = {
                "Todos os dias da semana": 4,
                "De 3 a 4 dias da semana": 3,
                "De 1 a 2 dias da semana": 2,
                "Nunca": 1
            };
            const sonoMap = {
                "Excelente": 5,
                "Boa": 4,
                "Regular": 3,
                "Ruim": 2,
                "Muito ruim": 1
            };
            const atividadeMap = {
                "Diariamente": 5,
                "3-4 vezes por semana": 4,
                "1-2 vezes por semana": 3,
                "Raramente": 2,
                "Nunca": 1
            };

            // 2) Cálculo dos escores (usando a chave depressao_raw)
            const ansiedadeScore =
                (freqMap[answers.nervosismo] || 0) +
                (freqMap[answers.preocupacao] || 0);

            const depressaoScore =
                (freqMap[answers.interesse] || 0) +
                (freqMap[answers.depressao_raw] || 0);

            const estresseScore =
                (freqMap[answers.estresse] || 0) +
                (extraMap[answers.hora_extra] || 0);

            const qualidadeVidaScore =
                (sonoMap[answers.sono] || 0) +
                (atividadeMap[answers.atividade_fisica] || 0);

            // 3) Geração das classificações
            const ansiedadeClass = getClassificacao(ansiedadeScore, 8);
            const depressaoClass = getClassificacao(depressaoScore, 8);
            const estresseClass = getClassificacao(estresseScore, 8);
            const qualidadeClass = getClassificacao(qualidadeVidaScore, 10);

            const scoreTotal = ansiedadeScore + depressaoScore + estresseScore + qualidadeVidaScore;
            const riscoPrincipal = getClassificacao(scoreTotal, 34);

            // 4) Monta recomendação
            let recomendacao = "";
            if (riscoPrincipal.nivel === "BAIXO") {
                recomendacao = "Sua saúde mental aparenta estar preservada. Continue cuidando de si!";
            } else if (riscoPrincipal.nivel === "NORMAL/LEVE") {
                recomendacao = "Há alguns sinais que merecem atenção. Considere práticas de autocuidado.";
            } else if (riscoPrincipal.nivel === "MODERADO") {
                recomendacao = "Identificamos sinais importantes. Recomendamos acompanhamento psicológico.";
            } else {
                recomendacao = "Indica necessidade urgente de suporte. Busque ajuda profissional.";
            }

            // 5) Injeção dos resultados em `answers` e envio
            answers.ansiedade = ansiedadeClass.nivel;
            answers.ansiedade_cor = ansiedadeClass.cor;

            answers.depressao = depressaoClass.nivel;
            answers.depressao_cor = depressaoClass.cor;

            answers.estresse = estresseClass.nivel;
            answers.estresse_cor = estresseClass.cor;

            answers.qualidade = qualidadeClass.nivel;
            answers.qualidade_cor = qualidadeClass.cor;

            answers.risco = riscoPrincipal.nivel;
            answers.risco_cor = riscoPrincipal.cor;

            answers.recomendacao = recomendacao;

            const adminId = getAdminIdFromURL();
            fetch(`/submit_quiz?admin=${adminId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(answers)
            });

            // 6) Atualiza barra de progresso
            document.getElementById("progress-bar").style.width = "100%";
            document.getElementById("progress-text").textContent = "Avaliação Concluída";
            // finalmente renderiza o resultado na tela
            container.innerHTML = `
      <div class="result-card rounded-2xl p-8 space-y-6 slide-up">
        <div class="text-center">
          <div class="text-6xl mb-4">${riscoPrincipal.nivel === "BAIXO" ? "🌟" :
                    riscoPrincipal.nivel === "NORMAL/LEVE" ? "⚠️" :
                        riscoPrincipal.nivel === "MODERADO" ? "🔶" : "🚨"
                }</div>
          <h2 class="text-3xl font-bold text-[#dd1b35] mb-4">Resultado da Avaliação</h2>
          <h3 class="text-xl font-semibold mb-4">${answers.nome},</h3>
        </div>
        
        <div class="bg-white rounded-xl p-6 shadow-md space-y-4">
          <div class="text-center">
            <p class="text-lg font-medium mb-4">
              Seu grau de risco é <span style="color: ${riscoPrincipal.cor}; font-weight:bold;">
                ${riscoPrincipal.nivel}
              </span>.
            </p>
            <p class="text-gray-700 leading-relaxed">${recomendacao}</p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="font-semibold text-gray-800">Ansiedade:</p>
              <span style="color: ${ansiedadeClass.cor}; font-weight:bold;">${ansiedadeClass.nivel}</span>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="font-semibold text-gray-800">Depressão:</p>
              <span style="color: ${depressaoClass.cor}; font-weight:bold;">${depressaoClass.nivel}</span>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="font-semibold text-gray-800">Estresse:</p>
              <span style="color: ${estresseClass.cor}; font-weight:bold;">${estresseClass.nivel}</span>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="font-semibold text-gray-800">Qualidade de Vida:</p>
              <span style="color: ${qualidadeClass.cor}; font-weight:bold;">
                ${qualidadeClass.nivel === "BAIXO" ? "BOA" :
                    qualidadeClass.nivel === "NORMAL/LEVE" ? "REGULAR" :
                        qualidadeClass.nivel === "MODERADO" ? "RUIM" : "MUITO RUIM"}
              </span>
            </div>
          </div>
          
          <div class="text-sm text-gray-600 text-center mt-4">
            <p><strong>Data da Avaliação:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
            <p><strong>Pronto Socorro (3m):</strong> ${answers.pronto_socorro || "0"} vez(es)</p>
          </div>
        </div>
        
        <div class="text-center">
          <button onclick="restart()" class="btn-primary text-white px-8 py-4 rounded-xl text-lg font-semibold inline-flex items-center gap-3">
            <span>🔄</span><span>Refazer Avaliação</span>
          </button>
        </div>
      </div>
    `;
        }

        function restart() {
            currentQuestion = 0;
            Object.keys(answers).forEach(key => delete answers[key]);
            renderQuestion();
        }

        // Inicializar questionário
        renderQuestion();
    </script>
</body>

</html>